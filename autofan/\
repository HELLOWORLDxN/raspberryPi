import dev,runStruct
import collections,time,math
from tempData import TempData
class ALG():
    def __init__(self,dataSource):
        self.__data=dataSource
        self.__lastCaculateTime=0
    @property
    def data():
        return self.__data
    @data.setter
    def data(self,value):
        if isinstance(value,TempData):
            self.__data=TempData
        else:
            raise AttributeException('object of calss <ALG>:function <data.setter> need type <TempData> given %' %type(alg))
    def caculate(self,traceDur=5,traceDeep=(3,-1),precision=0.1):
        if traceDeep[1]>=0 and traceDeep[1]<traceDeep[0]:
            traceDeep=(traceDeep[0],traceDeep[1])
        curTimeStamp=time.time()
        data=[] #temp/s
        doCal=False
        preTime=None
        preTemp=None
        i=-1
        lenData=len(self.__data)
        if lenData>0:
            while self.__lastCaculateTime<self.__data[i].logTime:
                if curTimeStamp-self.__data[i].logTime>=traceDur:
                    doCal=True
                    break
                temp=self.__data[i]
                if preTime and preTemp:
                    data.insert(0,(preTemp-temp.temp)/(preTime-temp.logTime))
                preTime,preTemp=temp.logTime,temp.temp
                i-=1
                if abs(i)>lenData or (traceDeep[1]>=0 and traceDeep[1]<abs(i)):
                    break
        if len(data)>=traceDeep[0]:
            self.__lastCaculateTime=curTimeStamp
            avg=sum(data)/len(data)
            ret=math.atan(avg)/(math.pi/2)
            if ret<precision:
                return 0
            return ret
        else:
            return 0
        
        

class FanManager(runStruct.LoopInside):
    def __init__(self,fan=None,*,bootTemp=50,pwOffTemp=45,sens=5,alg=ALG(TempData(50))):
        super().__init__()
        self.fan=fan
        self.__bootTemp=bootTemp
        self.__pwOffTemp=pwOffTemp
        self.__sens=sens

    def setALG(self,alg):
        if isinstance(alg,ALG):
            self.__alg=alg
        else:
            raise AttributeException('object of calss <FanManager>:function <setALG> need type <ALG> given %' %type(alg))
    @property
    def sens(self):
        return self.__sens
    @sens.setter
    def sens(self,value):
        assert isinstance(value,(int,float))
        self.__sens=value
    @property
    def bootTemp(self):
        return self.__bootTemp
    @bootTemp.setter
    def bootTemp(self,value):
        assert isinstance(value,(int,float))
        self.__bootTemp=value
    @property
    def pwOffTemp(self):
        return self.__pwOffTemp
    @pwOffTemp.setter
    def pwOffTemp(self,value):
        assert isinstance(value,(int,float))
        self.__pwOffTemp=value
    @property
    def fan(self):
        return self.__fan
    @fan.setter
    def fan(self,fan=None):
        if isinstance(fan,dev.Fan) or fan==None:
            self.__fan=fan
        else:
            raise AttributeException('object of calss <FanManager>:function <setFan> need type <Fan> given %' %type(fan))
    def speedCaculate(self):
        tempData=TempData()
        if tempData:
            lastTemp=tempData[-1].temp
            print(tempData[-1],'+')
            print(lastTemp,'+')
            print(self.bootTemp,'+')
            if self.bootTemp<lastTemp:
                offset=self.alg.caculate()*self.__sens
                self.fan.offsetspeed(offset)
            if self.pwOffTemp>lastTemp:
                self.fan.speed=0

    def autoSpeed(self,interval=3):
        if self.loop.isStarted:
            raise Exception('TempData is updateing dont call keepingUpdate again')
        self.__loop.sleepTime=interval
        self.__loop.funcAppend(self.speedCaculate)
        self.__loop.start()
    
if __name__=='__main__':
    def testALG():
        tempData=TempData()
        alg=ALG(tempData)
        def printCal():
            print(alg.caculate())
        tempData.loop.funcAppend(printCal)
        tempData.keepingUpdate()
    def testManager():
        import RPi.GPIO as GPIO
        GPIO.setmode(GPIO.BOARD)
        fan=dev.Fan(11)
        fM=FanManager(fan,bootTemp=30)
        tempData=TempData()
        tempData.loop.funcAppend(fM.speedCaculate)
        tempData.keepingUpdate()
    testManager()

